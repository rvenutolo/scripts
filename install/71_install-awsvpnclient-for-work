#!/usr/bin/env bash

# References:
# https://docs.aws.amazon.com/vpn/latest/clientvpn-user/client-vpn-connect-linux-install.html
# https://sailokesh.hashnode.dev/connecting-to-aws-vpn-client-on-ubuntu-2204-workaround?source=more_articles_bottom_blogs
# https://repost.aws/questions/QUNJeF_ja_Suykous7EvfX5Q/aws-client-vpn-on-ubuntu-22-04
# https://gist.github.com/tomaszgiba/4b0c04a6b4b0048e6a582b19133014b7
# https://gist.github.com/thiagozs/4d8c6e090a027fae3dd883163615f91e

set -euo pipefail

#shellcheck disable=SC1091
source "${SCRIPTS_DIR}/functions.bash"
check_not_root
check_no_args "$@"

if ! is_work; then
  exit 0
fi
if ! is_ubuntu; then
  log 'This is a work computer, but not Ubuntu. Skipping installing AWS VPN Client'
  exit 0
fi
if ! prompt_yn 'Install AWS VPN Client?'; then
  exit 0
fi

if ! dpkg --status 'libssl1.1' > '/dev/null' 2>&1; then
  log 'Installing old libssl1.1 package for AWS VPN client'
  # http://security.ubuntu.com/ubuntu/pool/main/o/openssl/
  readonly libssl1_url='http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.23_amd64.deb'
  libssl1_deb="$(mktemp --suffix "__$(basename "${libssl1_url}")")"
  readonly libssl1_deb
  download "${libssl1_url}" "${libssl1_deb}"
  sudo dpkg --install "${libssl1_deb}"
  log 'Installed old libssl1.1 package for AWS VPN client'
fi

if ! dpkg --status 'awsvpnclient' > '/dev/null' 2>&1; then

  log 'Installing AWS VPN Client'
  readonly vpnclient_url='https://d20adtppz83p9s.cloudfront.net/GTK/latest/awsvpnclient_amd64.deb'
  vpnclient_deb="$(mktemp --suffix "__$(basename "${vpnclient_url}")")"
  readonly vpnclient_deb
  download "${vpnclient_url}" "${vpnclient_deb}"
  sudo dpkg --install "${vpnclient_deb}"
  log 'Installed AWS VPN Client'

  log 'Downloading AWS VPN OVPN file'
  readonly de_ovpn_file_url='https://raw.githubusercontent.com/rvenutolo/crypt/main/ovpn/de.ovpn'
  readonly de_ovpn_file="${HOME}/de.ovpn"
  download-decrypt "${de_ovpn_file_url}" "${de_ovpn_file}"
  log 'Downloaded AWS VPN OVPN file'

  log 'Installing openvpn-systemd-resolved and restarting systemd-resolved'
  sudo apt-get install 'openvpn-systemd-resolved'
  sudo systemctl restart 'systemd-resolved'
  log 'Installed openvpn-systemd-resolved and restarted systemd-resolved'

fi

readonly vpnclient_dir='/opt/awsvpnclient'
readonly vpnclient_symlink="${vpnclient_dir}/awsvpnclient"
if ! file_exists "${vpnclient_symlink}"; then
  log "Creating ${vpnclient_symlink} symbolic link"
  sudo ln --symbolic 'AWS VPN Client' "${vpnclient_symlink}"
  log "Created ${vpnclient_symlink} symbolic link"
fi

readonly service_file='/etc/systemd/system/awsvpnclient.service'
if ! file_exists "${service_file}"; then
  die "Service file ${service_file} does not exist"
fi
readonly dotnet_env_line='Environment=DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1'
if ! grep --quiet --fixed-strings "${dotnet_env_line}" "${service_file}"; then
  log 'Updating AWS VPN Client service file'
  sudo sed --in-place "/\[Service]/a ${dotnet_env_line}" "${service_file}"
  log 'Updated AWS VPN Client service file'
fi

readonly desktop_entry='/usr/share/applications/awsvpnclient.desktop'
readonly new_exec_line="Exec=env DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1 ${vpnclient_symlink} %u"
if ! grep --quiet --fixed-strings "${new_exec_line}" "${desktop_entry}"; then
  log 'Updating AWS VPN Client desktop entry'
  sudo sed --in-place "s#Exec=/opt/awsvpnclient/.*#${new_exec_line}#" "${desktop_entry}"
  log 'Updated AWS VPN Client desktop entry'
fi



