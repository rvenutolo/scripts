#!/usr/bin/env bash

set -euo pipefail

#shellcheck disable=SC1091
source "${SCRIPTS_DIR}/functions.bash"

# $1 = packages file
# $2 = regex ('\[' or ']'
function get_line_number() {
  grep --line-number --max-count='1' "$2" "$1" | cut --delimiter=':' --fields='1'
}

# $1 = packages file
# $2 = 'nixpkgs' or 'nixpkgs-unstable'
function write_packages_into() {
  check_at_least_2_args "$@"
  local packages_file="$1"
  local package_type="$2"
  shift 2
  local temp_file
  temp_file="$(mktemp)" || exit 1
  readonly temp_file
  {
    awk \
      "NR <= $(get_line_number "${packages_file}" '\[')" \
      "${packages_file}"
    get_universal_packages "${package_type}" "$@" | sed 's/^/    /'
    awk \
      "NR >= $(get_line_number "${packages_file}" ']')" \
      "${packages_file}"
  } >> "${temp_file}"
  mv "${temp_file}" "${packages_file}"
}

write_packages_into "${HOME_MANAGER_DIR}/packages-stable.nix" 'nixpkgs' "$@"
write_packages_into "${HOME_MANAGER_DIR}/packages-unstable.nix" 'nixpkgs-unstable' "$@"
